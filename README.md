# 15-779 Project: Prefix-Aware Attention

This repository contains:
- **`chunk-attention-tk/`**: the ChunkAttention + ThunderKittens codebase (vendored).
- **`hydragen-tk/`**: the Hydragen + TK codebase (vendored).
- **`bench/`**: benchmarking + plotting harness for ChunkAttention sweeps (CSV generation + gnuplot figures).
- **`results/`**: CSVs + PNGs generated by the benchmarks.
- **Plots in `results/` are reproducible** from the code in this repo.
- **TK (ThunderKittens) sweep generation** via the `attn_chunk_first` binary:
  - supports `--sweep` and `--bench` (CUDA-event kernel-only timing).
  - the “4-warp” configuration (2 compute warps + 2 load-assist warps) is the one used for `results/chunk_attn_tk/sweep_kv_4warp.csv`.
- **Native kernel-only sweep is restored** via a C++ executable target: `bench_chunk_first_kernel`.
- **Note**: If you regenerate results, expect small run-to-run variance in `latency_ms` (a few %).

## Directory layout 

```
15-779-Project/
├── bench/
│   ├── plot/                         # gnuplot plot templates (CSV -> PNGs)
│   ├── *.py / *.sh                   # runnable scripts (sweeps + plotting + aggregation)
│   └── scripts/                      # (legacy; kept empty)
├── results/
│   ├── chunk_attn_tk/                # TK sweep CSVs + plots
│   ├── chunk_attn_native/            # native sweep CSVs + plots
│   └── comparisons/                  # optional place for custom overlays
├── chunk-attention-tk/               # vendored repo (ThunderKittens + chunk_attn)
└── hydragen-tk/                      # vendored repo (Hydragen + TK)
```

## What’s in `bench/` (and how to use it)

The `bench/` directory is a lightweight benchmark + plotting harness for **ChunkAttention prefix-aware attention**. It is centered around running *parameter sweeps* that vary the grid size:

- **blocks**: \( \texttt{blocks} = \texttt{n\_heads} \times \texttt{n\_chunks} \)
- The “native” sweep is designed to mirror the ThunderKittens sweep convention: `n_seqs=32`, `chunk_size=64`, `d_head=128`, varying `n_heads` and `n_chunks`.

### `bench/scripts/` (what each script does)

- **`benchmark_chunk_attn_sweep.py`**: runs a CUDA-event timed sweep using the installed Python package `chunk_attn`.
  - Constructs `chunk_attn.Attention(..., share_prefix=True)` and duplicates one shared-prefix sequence to create `n_seqs` sequences that share the same prefix (prefix-trie sharing).
  - Writes a CSV with columns:
    - `n_seqs,n_heads,n_chunks,blocks`
    - `latency_ms` (per launch, averaged over `--iters`)
    - `tflops` and `compute_eff_pct` (using an H100 BF16 peak constant)
    - `kv_gbps` and `kv_mem_eff_pct` (K/V read bandwidth estimate vs an H100 peak GB/s constant)
  - Useful args: `--dtype {fp16,bf16}`, `--partition <int>`, `--device <idx>`, `--warmup`, `--iters`.

- **`aggregate_by_blocks.py`**: groups sweep rows by `blocks` and averages numeric columns.
  - The sweeps often include multiple `(n_heads, n_chunks)` factorizations that yield the same `blocks`; aggregating makes comparison plots cleaner.

- **`plot_sweep.sh`**: plots a single sweep CSV into an output directory using gnuplot (`bench/plot/plot_sweep.gp`).

- **`plot_compare.sh`**: plots **TK vs native** overlays.
  - Internally aggregates both input CSVs to one point per `blocks` (writes `tk_agg.csv` and `native_agg.csv` into the output directory), then calls gnuplot (`bench/plot/plot_compare.gp`).

### `bench/plot/` (gnuplot templates)

- **`plot_sweep.gp`**: produces a small set of single-sweep figures (latency, throughput, bandwidth, efficiency, plus combined overview panels).
- **`plot_compare.gp`**: produces the same kinds of figures but with two curves (TK vs native).

## What’s already generated

ChunkAttention graphs and CSVs live under:
- `results/chunk_attn_tk/` (TK kernel-only sweep + plots)
- `results/chunk_attn_native/` (native sweeps + plots)

Comparison overlays (TK vs native, kernel-only) are in:
- `results/chunk_attn_tk/comparison_plots/`
- `results/chunk_attn_tk/comparison_plots_4warp/` (optimized TK configuration)

## Reproduce the graphs (Bridges2 H100 example)

### 0) Recommended environment notes
- On non-interactive shells, set: `export HOSTNAME=$(hostname)`
- Load CUDA modules when building/running CUDA code:
  - `module load gcc/13.3.1-p20240614 cuda/12.6.1`

### 1) Plot from existing CSV (no rebuild)

```bash
cd bench/scripts

# Plot a single sweep
./plot_sweep.sh ../../results/chunk_attn_tk/sweep_kv_4warp.csv ../../results/chunk_attn_tk/minimal_plots

# Overlay TK vs native kernel-only sweeps
./plot_compare.sh \
  ../../results/chunk_attn_tk/sweep_kv_4warp.csv \
  ../../results/chunk_attn_native/sweep_native_kernel_only.csv \
  ../../results/chunk_attn_tk/comparison_vs_native_4warp
```

### 2) Run the native Python sweep (uses installed `chunk_attn`)

```bash
export HOSTNAME=$(hostname)
module load gcc/13.3.1-p20240614 cuda/12.6.1
python bench/scripts/benchmark_chunk_attn_sweep.py \
  --csv results/chunk_attn_native/sweep_native.csv
```

### 2b) Run the TK kernel-only sweep (rebuilds `attn_chunk_first` binary)

The TK benchmark is built into the TK binary (not a Python script). For convenience, use:

```bash
export HOSTNAME=$(hostname)
module load gcc/13.3.1-p20240614 cuda/12.6.1

# Default: build+run the ChunkAttention TK kernel sweep (writes CSV)
./bench/scripts/run_tk_sweep.sh --out results/chunk_attn_tk/sweep_kv_4warp.csv
```

### 2c) Run the native kernel-only sweep (C++ executable)

This builds and runs `bench_chunk_first_kernel`, which times the native CUDA kernel via CUDA events:

```bash
export HOSTNAME=$(hostname)
module load gcc/13.3.1-p20240614 cuda/12.6.1

# Configure + build (you must point -DTORCH at your torch cmake prefix)
cmake -S chunk-attention-tk/chunk_attn -B chunk-attention-tk/chunk_attn/build \
  -DUSE_CUDA=ON -DUSE_MKL=OFF \
  -DTORCH="$(python -c 'import torch.utils; print(torch.utils.cmake_prefix_path)')" \
  -DPYTHON_EXECUTABLE="$(which python)" \
  -DPython3_EXECUTABLE="$(which python)" \
  -DPython3_ROOT_DIR="$(python -c 'import sys; import pathlib; print(pathlib.Path(sys.executable).resolve().parent.parent)')"
cmake --build chunk-attention-tk/chunk_attn/build -j --target bench_chunk_first_kernel

./chunk-attention-tk/chunk_attn/build/cpp/tests/bench_chunk_first_kernel --sweep \
  > results/chunk_attn_native/sweep_native_kernel_only.csv
```

### 3) (Optional) Plot the sweep / generate overlays

```bash
# Plot a single CSV
./bench/scripts/plot_sweep.sh results/chunk_attn_native/sweep_native.csv results/chunk_attn_native/plots

# Overlay TK vs native (writes aggregated CSVs inside the output dir)
./bench/scripts/plot_compare.sh \
  results/chunk_attn_tk/sweep_kv_4warp.csv \
  results/chunk_attn_native/sweep_native_kernel_only.csv \
  results/chunk_attn_tk/comparison_vs_native_4warp
```
