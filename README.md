# 15-779 Project: Prefix-Aware Attention (Bench Harness + Results)

This repository contains:
- **`chunk-attention-tk/`**: the ChunkAttention + ThunderKittens codebase (vendored).
- **`hydragen-tk/`**: the Hydragen + TK codebase (vendored).
- **`bench/`**: benchmarking + plotting harness for ChunkAttention sweeps (CSV generation + gnuplot figures).
- **`results/`**: CSVs + PNGs generated by the benchmarks.

## Directory layout 

```
15-779-Project/
├── bench/
│   ├── plot/                         # gnuplot plot templates (CSV -> PNGs)
│   └── scripts/                      # runnable scripts (native sweep + plotting + aggregation)
├── results/
│   ├── chunk_attn_tk/                # TK sweep CSVs + plots
│   ├── chunk_attn_native/            # native sweep CSVs + plots
│   └── comparisons/                  # optional place for custom overlays
├── chunk-attention-tk/               # vendored repo (ThunderKittens + chunk_attn)
└── hydragen-tk/                      # vendored repo (Hydragen + TK)
```

## What’s in `bench/` (and how to use it)

The `bench/` directory is a lightweight benchmark + plotting harness for **ChunkAttention prefix-aware attention**. It is centered around running *parameter sweeps* that vary the grid size:

- **blocks**: \( \texttt{blocks} = \texttt{n\_heads} \times \texttt{n\_chunks} \)
- The “native” sweep is designed to mirror the ThunderKittens sweep convention: `n_seqs=32`, `chunk_size=64`, `d_head=128`, varying `n_heads` and `n_chunks`.

### `bench/scripts/` (what each script does)

- **`benchmark_chunk_attn_sweep.py`**: runs a CUDA-event timed sweep using the installed Python package `chunk_attn`.
  - Constructs `chunk_attn.Attention(..., share_prefix=True)` and duplicates one shared-prefix sequence to create `n_seqs` sequences that share the same prefix (prefix-trie sharing).
  - Writes a CSV with columns:
    - `n_seqs,n_heads,n_chunks,blocks`
    - `latency_ms` (per launch, averaged over `--iters`)
    - `tflops` and `compute_eff_pct` (using an H100 BF16 peak constant)
    - `kv_gbps` and `kv_mem_eff_pct` (K/V read bandwidth estimate vs an H100 peak GB/s constant)
  - Useful args: `--dtype {fp16,bf16}`, `--partition <int>`, `--device <idx>`, `--warmup`, `--iters`.

- **`aggregate_by_blocks.py`**: groups sweep rows by `blocks` and averages numeric columns.
  - The sweeps often include multiple `(n_heads, n_chunks)` factorizations that yield the same `blocks`; aggregating makes comparison plots cleaner.

- **`plot_sweep.sh`**: plots a single sweep CSV into an output directory using gnuplot (`bench/plot/plot_sweep.gp`).

- **`plot_compare.sh`**: plots **TK vs native** overlays.
  - Internally aggregates both input CSVs to one point per `blocks` (writes `tk_agg.csv` and `native_agg.csv` into the output directory), then calls gnuplot (`bench/plot/plot_compare.gp`).

### `bench/plot/` (gnuplot templates)

- **`plot_sweep.gp`**: produces a small set of single-sweep figures (latency, throughput, bandwidth, efficiency, plus combined overview panels).
- **`plot_compare.gp`**: produces the same kinds of figures but with two curves (TK vs native).

## What’s already generated

ChunkAttention graphs and CSVs live under:
- `results/chunk_attn_tk/` (TK kernel-only sweep + plots)
- `results/chunk_attn_native/` (native sweeps + plots)

Comparison overlays (TK vs native, kernel-only) are in:
- `results/chunk_attn_tk/comparison_plots/`
- `results/chunk_attn_tk/comparison_plots_4warp/` (optimized TK configuration)

## Reproduce the graphs (Bridges2 H100 example)

### 0) Recommended environment notes
- On Bridges2 non-interactive shells, set: `export HOSTNAME=$(hostname)`
- Load CUDA modules when running binaries that link CUDA dynamically.

### 1) Plot from existing CSV (no rebuild)

```bash
cd bench/scripts

# Plot a single sweep
./plot_sweep.sh ../../results/chunk_attn_tk/sweep_kv_4warp.csv ../../results/chunk_attn_tk/minimal_plots_4warp

# Overlay TK vs native kernel-only sweeps
./plot_compare.sh \
  ../../results/chunk_attn_tk/sweep_kv_4warp.csv \
  ../../results/chunk_attn_native/sweep_native_kernel_only.csv \
  ../../results/chunk_attn_tk/comparison_vs_native_4warp
```

### 2) Run the native Python sweep (uses installed `chunk_attn`)

```bash
export HOSTNAME=$(hostname)
module load gcc/13.3.1-p20240614 cuda/12.6.1

python bench/scripts/benchmark_chunk_attn_sweep.py \
  --csv results/chunk_attn_native/sweep_native.csv

# If you use the Bridges2 conda env from the paper setup, you can also do:
/jet/home/billyli/data_billyli/jason/miniconda3/bin/conda run -n cot \
  python bench/scripts/benchmark_chunk_attn_sweep.py \
  --csv results/chunk_attn_native/sweep_native.csv
```

### 3) (Optional) Plot the sweep / generate overlays

```bash
# Plot a single CSV
./bench/scripts/plot_sweep.sh results/chunk_attn_native/sweep_native.csv results/chunk_attn_native/plots

# Overlay TK vs native (writes aggregated CSVs inside the output dir)
./bench/scripts/plot_compare.sh \
  results/chunk_attn_tk/sweep_kv_4warp.csv \
  results/chunk_attn_native/sweep_native_kernel_only.csv \
  results/chunk_attn_tk/comparison_vs_native_4warp
```
