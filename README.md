# 15-779 Project: Prefix-Aware Attention (Bench Harness + Results)

This repository contains:
- **`chunk-attention-tk/`**: the ChunkAttention + ThunderKittens codebase (vendored).
- **`hydragen-tk/`**: the Hydragen + TK codebase (vendored).
- **`bench/`**: benchmarking + plotting scripts 
- **`results/`**: CSVs + PNGs generated by the benchmarks.

## Directory layout 

```
15-779-Project/
├── bench/
│   ├── plot/                         # gnuplot plot templates
│   └── scripts/                      # runnable scripts (sweeps + plotting)
├── results/
│   ├── chunk_attn_tk/                # TK sweep CSVs + plots
│   ├── chunk_attn_native/            # native sweep CSVs + plots
│   └── comparisons/                  # optional place for custom overlays
├── chunk-attention-tk/               # vendored repo (ThunderKittens + chunk_attn)
└── hydragen-tk/                      # vendored repo (Hydragen + TK)
```

## What’s already generated

ChunkAttention graphs and CSVs live under:
- `results/chunk_attn_tk/` (TK kernel-only sweep + plots)
- `results/chunk_attn_native/` (native sweeps + plots)

Comparison overlays (TK vs native, kernel-only) are in:
- `results/chunk_attn_tk/comparison_plots/`
- `results/chunk_attn_tk/comparison_plots_4warp/` (optimized TK configuration)

## Reproduce the graphs (Bridges2 H100 example)

### 0) Recommended environment notes
- On Bridges2 non-interactive shells, set: `export HOSTNAME=$(hostname)`
- Load CUDA modules when running binaries that link CUDA dynamically.

### 1) Plot from existing CSV (no rebuild)

```bash
cd bench/scripts

# Plot a single sweep
./plot_sweep.sh ../../results/chunk_attn_tk/sweep_kv_4warp.csv ../../results/chunk_attn_tk/minimal_plots_4warp

# Overlay TK vs native kernel-only sweeps
./plot_compare.sh \
  ../../results/chunk_attn_tk/sweep_kv_4warp.csv \
  ../../results/chunk_attn_native/sweep_native_kernel_only.csv \
  ../../results/chunk_attn_tk/comparison_vs_native_4warp
```

### 2) Run the native Python sweep (uses installed `chunk_attn`)

```bash
export HOSTNAME=$(hostname)
module load gcc/13.3.1-p20240614 cuda/12.6.1

/jet/home/billyli/data_billyli/jason/miniconda3/bin/conda run -n cot \
  python bench/scripts/benchmark_chunk_attn_sweep.py \
    --csv results/chunk_attn_native/sweep_native.csv
```
